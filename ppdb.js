const sheetName="PPDB",folderName="PPDB File Data",scriptProp=PropertiesService.getScriptProperties();function initialSetup(){const e=SpreadsheetApp.getActiveSpreadsheet();scriptProp.setProperty("key",e.getId())}function doPost(e){const t=LockService.getScriptLock();t.tryLock(1e4);try{const r=SpreadsheetApp.openById(scriptProp.getProperty("key")).getSheetByName("PPDB"),o=r.getRange(1,1,1,r.getLastColumn()).getValues()[0],i=r.getLastRow()+1,s=e.parameter,n=JSON.parse(e.parameters.files);let a;const c=DriveApp.getFoldersByName(folderName);a=c.hasNext()?c.next():DriveApp.createFolder(folderName);const p={};for(const e of n){const t=Utilities.newBlob(Utilities.base64Decode(e.base64),e.type,e.name),r=a.createFile(t).setSharing(DriveApp.Access.ANYONE_WITH_LINK,DriveApp.Permission.VIEW).getDownloadUrl();p[e.fieldName]=r}const g=o.map((e=>"WAKTU_SUBMIT"===e?Utilities.formatDate(new Date,Session.getScriptTimeZone(),"dd/MM/yyyy (HH:mm)"):p[e]?p[e]:s[e]));return r.getRange(i,1,1,g.length).setValues([g]),ContentService.createTextOutput(JSON.stringify({result:"success",row:i})).setMimeType(ContentService.MimeType.JSON)}catch(e){return ContentService.createTextOutput(JSON.stringify({result:"error",error:e.toString()})).setMimeType(ContentService.MimeType.JSON)}finally{t.releaseLock()}}function onEdit(e){if(1==e.range.getRow()){var t=e.range.getValue().toString().toUpperCase().replace(/\s+/g,"_");e.range.setValue(t),e.range.setFontWeight("bold").setBackground("#cccccc").setHorizontalAlignment("center")}}
